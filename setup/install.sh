#!/bin/bash

# boot to textmode only
systemctl set-default multi-user.target

# update system
apt-get update && apt-get upgrade -y && apt-get dist-upgrade -y

# setup date/time
dpkg-reconfigure tzdata

# enable gps & gps ntp time
apt-get install ntp gpsd gpsd-clients
sed -i 's/^\(GPSD_OPTIONS=\).*/\1"-n"/' /etc/default/gpsd
sed -i '/^pool/d' /etc/ntp.conf
sed -i '/^fudge/d' /etc/ntp.conf
sed -i '/^server/d' /etc/ntp.conf
cat <<EOF >> /etc/ntp.conf
server 127.127.28.0 minpoll 4 maxpoll 4
fudge 127.127.28.0 time1 0.535 refid GPS
server 127.127.28.1 minpoll 4 maxpoll 4 prefer
fudge 127.127.28.1 refid PPS
server 0.pool.ntp.org
server 1.pool.ntp.org
server 2.pool.ntp.org
server 3.pool.ntp.org
EOF
systemctl restart gpsd.service
systemctl restart ntp.service

# setup hostadp foer local wlan access
# install required software
apt-get install dnsmasq hostapd iptables-save

# forwarding and natting
sysctl -w net.ipv4.ip_forward=1
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT
iptables-save > /etc/iptables/rules.v4

# bugfix https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=860064
mv /usr/share/dns/root.ds /usr/share/dns/root.ds.bak

# copy dnsmasq conf
cp -f ./dnsmasq.conf /etc/dnsmasq.d/dnsmasq.conf && chmod 0644 /etc/dnsmasq.d/dnsmasq.conf && rm /etc/dnsmasq.d/README
cp -f ./hostapd.conf /etc/hostapd.conf && chmod 0644 /etc/hostapd.conf
cp -f ./interfaces /etc/network/interfaces && chmod 0644 /etc/network/interfaces
sed -i 's/^.*\(DAEMON_CONF=\).*/\1"\/etc\/hostapd.conf"/' /etc/default/hostapd
sed -i 's/^.*\(DAEMON_OPTS=\).*/\1"-d -t"/' /etc/default/hostapd
sed -i 's/^.*\(IGNORE_RESOLVCONF=\).*/\1yes/' /etc/default/dnsmasq
ifdown wlan0
ifup wlan0
systemctl restart dnsmasq.service
systemctl restart hostapd.service

# Changing the SSH host keys
rm /etc/ssh/ssh_host_*
dpkg-reconfigure openssh-server
service ssh restart
