#!/bin/bash

#######################################
# update init setup
#######################################
# boot to textmode only
systemctl set-default multi-user.target

# update system
apt-get update && apt-get upgrade -y && apt-get dist-upgrade -y

# setup date/time
dpkg-reconfigure tzdata

#######################################
# setup GPS + NTP via GPS
#######################################
# enable gps & gps ntp time
apt-get install ntp gpsd gpsd-clients
sed -i 's/^\(GPSD_OPTIONS=\).*/\1"-n"/' /etc/default/gpsd
sed -i '/^pool/d' /etc/ntp.conf
sed -i '/^fudge/d' /etc/ntp.conf
sed -i '/^server/d' /etc/ntp.conf
cat <<EOF >> /etc/ntp.conf
server 127.127.28.0 minpoll 4 maxpoll 4
fudge 127.127.28.0 time1 0.535 refid GPS
server 127.127.28.1 minpoll 4 maxpoll 4 prefer
fudge 127.127.28.1 refid PPS
server 0.pool.ntp.org
server 1.pool.ntp.org
server 2.pool.ntp.org
server 3.pool.ntp.org
EOF
systemctl restart gpsd.service
systemctl restart ntp.service
systemctl enable gpsd.service
systemctl enable ntp.service

#######################################
# setup hostadp foer local wlan access
#######################################

# install required software
apt-get install dnsmasq hostapd iptables iptables-save -y

# forwarding and nating
# forwarding
sysctl -w net.ipv4.ip_forward=1
sed -i 's/^.*\(net.ipv4.ip_forward=\).*/\11/' /etc/sysctl.conf
## cleanup
iptables --flush
iptables --table nat --flush
iptables --delete-chain
iptables --table nat --delete-chain
## setup nat
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE
iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT
iptables -A FORWARD -i wlan0 -o eth1 -j ACCEPT
iptables-save > /etc/iptables.up.rules
echo '#!/bin/bash' > /etc/network/if-pre-up.d/iptables
echo "/sbin/iptables-restore < /etc/iptables.up.rules" >> /etc/network/if-pre-up.d/iptables
chmod +x /etc/network/if-pre-up.d/iptables

# bugfix https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=860064
mv /usr/share/dns/root.ds /usr/share/dns/root.ds.bak

# copy dnsmasq conf
cp -f ./NetworkManager.conf /etc/NetworkManager/NetworkManager.conf && chmod 0644 /etc/NetworkManager/NetworkManager.conf
cp -f ./dnsmasq.conf /etc/dnsmasq.d/dnsmasq.conf && chmod 0644 /etc/dnsmasq.d/dnsmasq.conf && rm /etc/dnsmasq.d/README
cp -f ./hostapd.conf /etc/hostapd.conf && chmod 0644 /etc/hostapd.conf
cp -f ./interfaces /etc/network/interfaces && chmod 0644 /etc/network/interfaces
sed -i 's/^.*\(DAEMON_CONF=\).*/\1"\/etc\/hostapd.conf"/' /etc/default/hostapd
sed -i 's/^.*\(DAEMON_OPTS=\).*/\1"-d -t"/' /etc/default/hostapd
sed -i 's/^.*\(IGNORE_RESOLVCONF=\).*/\1yes/' /etc/default/dnsmasq
ifdown wlan0
ifup wlan0
systemctl restart dnsmasq.service
systemctl restart hostapd.service
systemctl enable dnsmasq.service
systemctl enable hostapd.service

#######################################
# customize login message
#######################################
# DNS utils
apt-get install -y dnsutils toilet
myip="$(dig +short myip.opendns.com @resolver1.opendns.com)"
echo "My WAN/Public IP address: ${myip}"
cp /etc/issue /etc/issue-standard
cp -f ./show-ip-address /etc/network/if-up.d/show-ip-address && chmod +x /etc/network/if-up.d/show-ip-address

#######################################
# install webapp
#######################################
apt-get install mysql-server lighttpd libssl-dev python-dev python-pip ca-certificates openssl python python-openssl -y
pip install -r ../src/requirements.txt
cp -f ./lighttpd.conf /etc/lighttpd/lighttpd.conf && hmod 0644 /etc/lighttpd/lighttpd.conf
cp -f ./ptuweb.service /etc/systemd/system/ptuweb.service
systemctl daemon-reload
systemctl restart lighttpd
systemctl enable lighttpd
systemctl start mysql
systemctl enable mysql
systemctl start ptuweb
systemctl enable ptuweb
### create db user abd table
mysql -u root <<EOF
DROP USER IF EXISTS 'ptu'@'localhost';
CREATE USER 'ptu'@'localhost' IDENTIFIED BY 'ptu';
DROP DATABASE IF EXISTS ptu;
CREATE DATABASE ptu DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;
GRANT ALL ON ptu.* TO ptu@localhost IDENTIFIED BY 'ptu';
EOF

#######################################
# Changing the SSH host keys
#######################################
rm /etc/ssh/ssh_host_*
dpkg-reconfigure openssh-server
service ssh restart
