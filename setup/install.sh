#!/bin/bash

# boot to textmode only
systemctl set-default multi-user.target

# update system
apt-get update && apt-get upgrade -y && apt-get dist-upgrade -y

# setup date/time
dpkg-reconfigure tzdata

# enable gps & gps ntp time
apt-get install ntp gpsd gpsd-clients
sed -i 's/^\(GPSD_OPTIONS=\).*/\1"-n"/' /etc/default/gpsd
sed -i '/^pool/d' /etc/ntp.conf
sed -i '/^fudge/d' /etc/ntp.conf
sed -i '/^server/d' /etc/ntp.conf
cat <<EOF >> /etc/ntp.conf
server 127.127.28.0 minpoll 4 maxpoll 4
fudge 127.127.28.0 time1 0.535 refid GPS
server 127.127.28.1 minpoll 4 maxpoll 4 prefer
fudge 127.127.28.1 refid PPS
server 0.pool.ntp.org
server 1.pool.ntp.org
server 2.pool.ntp.org
server 3.pool.ntp.org
EOF
systemctl restart gpsd.service
systemctl restart ntp.service

# setup hostadp foer local wlan access
# install required software
apt-get install dnsmasq hostapd iptables-persistent

# forwarding and natting
sysctl -w net.ipv4.ip_forward=1
iptables -P FORWARD ACCEPT
iptables --table nat -A POSTROUTING -o wlan0 -j MASQUERADE
iptables-save > /etc/iptables/rules.v4



# Changing the SSH host keys
rm /etc/ssh/ssh_host_*
dpkg-reconfigure openssh-server
service ssh restart
