from flask import Blueprint, render_template, redirect, request, g, url_for, jsonify
from flask_login import login_required
from ... import app, db
from ...lib.passwords import SystemPasswords
from ...lib.systemd import Systemd
from forms.passwords import PasswordsForm
from gps3 import gps3

settings = Blueprint('settings', __name__, template_folder='templates', static_url_path='/static', static_folder='../../views/static', url_prefix='/settings')
thread = None

@settings.route('/passwords.html',methods=['GET','POST'])
@login_required
def passwords():
    form = PasswordsForm()
    if form.validate_on_submit():
        changed = False
        if form.appuser.data:
            if not SystemPasswords(db,g.user).app(password):
                flash('App password change error','danger')
                return render_template('passwords.html',form=form)
            flash('App password changed','success')
            changed = True
        if form.sshuser.data:
            if not SystemPasswords.ssh(password):
                flash('SSH password change error','danger')
                return render_template('passwords.html',form=form)
            flash('SSH password changed','success')
            changed = True
        if form.wlanuser.data:
            if len(password) < 8:
                flash('Password has to be at least 8 chars for WLAN!','danger')
                return render_template('passwords.html',form=form)
            if not SystemPasswords.wlan(password):
                flash('WLAN password change error','danger')
                return render_template('passwords.html',form=form)
            flash('WLAN password changed','success')
            changed = True
        if changed == True:
            return redirect(url_for('session.logout'))
        else:
            flash('No passwords for change selected','warning')
    return render_template('passwords.html',form=form)

def redirect_url(default='map.live'):
    return request.args.get('next') or \
           request.referrer or \
           url_for(default)

@settings.route('/wlantoggle',methods=['GET'])
@login_required
def togglewifi():
    if Systemd.running('kismet'):
        Systemd.stop('kismet')
    else:
        Systemd.start('kismet')
    return redirect(redirect_url())

@settings.route('/wlan.json',methods=['GET'])
@login_required
def wlanstatus():
    data = {'active': Systemd.running('kismet')}
    return jsonify(data)
