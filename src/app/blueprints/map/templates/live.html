{% extends "map.html" %}

{% block css %}
  {{ super() }}
  <style>
    .map {
      width: 100%;
      height: 600px;
      min-height: 600px;
    }
  </style>
{% endblock %}

{% block body %}
  <div id="map" class="map"></div>
{% endblock %}

{% block js %}
  {{ super() }}
  <script>
      var start = ol.proj.transform([{{gpsd.lon}},{{gpsd.lat}}], 'EPSG:4326', 'EPSG:3857');
      var dronePoint = new ol.geom.Point(start);
      var droneIconFeature = new ol.Feature({
        type: 'geoMarker',
        geometry: dronePoint,
        style: new ol.style.Style({
          text: new ol.style.Text({
            text: '\uf072',
            font: 'normal 28px FontAwesome',
            textBaseline: 'Bottom',
            stroke: new ol.style.Stroke({
              color: 'black',
              width: 3
            }),
            fill: new ol.style.Fill({
              color: 'red',
            })
          })
        })
      });

      var mobilePoint = new ol.geom.Point(ol.proj.transform([0,0], 'EPSG:4326', 'EPSG:3857'));
      var mobileIconFeature = new ol.Feature({
        type: 'geoMarker',
        geometry: mobilePoint,
        style: new ol.style.Style({
          text: new ol.style.Text({
            text: '\uf007',
            font: 'normal 28px FontAwesome',
            textBaseline: 'Bottom',
            stroke: new ol.style.Stroke({
              color: 'black',
              width: 3
            }),
            fill: new ol.style.Fill({
              color: 'lime',
            })
          })
        })
      });

      var view = new ol.View({
        center: start,
        zoom: 18
      });

      var wifiSource = new ol.source.Vector();
      function wifiStyle(feature) {
        retVal = [];
        var icon = new ol.style.Style({
          text: new ol.style.Text({
            text: '\uf1eb',
            font: 'normal 24px FontAwesome',
            textBaseline: 'Bottom',
            stroke: new ol.style.Stroke({
              color: 'white',
              width: 2
            }),
            fill: new ol.style.Fill({
              color: 'green',
            })
          })
        });
        retVal.push(icon);

        if(view.getZoom()>=10) {
          var ico = '\uf128';
          if(feature.get('crypto')) {
            var cry = feature.get('crypto');
            if(cry.indexOf('None')!=-1) {
              ico = '\uf09c'; // unlock
            } else if(cry.indexOf('WEP')!=-1) {
              ico = '\uf06d'; // fire
            } else if(cry.indexOf('WPA+TKIP')!=-1||cry.indexOf('WPA+PSK')!=-1) {
              ico = '\uf084'; // key
            } else if(cry.indexOf('WPA+')!=-1) {
              ico = '\uf023'; // lock
            }
          }
          var crypto = new ol.style.Style({
            text: new ol.style.Text({
              text: ico,
              offsetY: 7,
              offsetX: 7,
              font: 'normal 12px FontAwesome',
              textBaseline: 'Bottom',
              stroke: new ol.style.Stroke({
                color: 'white',
                width: 1
              }),
              fill: new ol.style.Fill({
                color: 'red',
              })
            })
          });
          retVal.push(crypto);
        }
        if(view.getZoom()>=19) {
          var description = '<Hidden SSID>';
          if(feature.get('ssid')) {
            description = feature.get('ssid');
          }
          if(feature.get('bssid')) {
            description +='\n'+feature.get('bssid')
          }
          var text = new ol.style.Style({
            text: new ol.style.Text({
              offsetY: -25,
              font: '12px bold Calibri,sans-serif',
              fill: new ol.style.Fill({ color: '#000' }),
              stroke: new ol.style.Stroke({
                color: '#fff', width: 2
              }),
              text: view.getZoom()>=19?description:''
            })
          });
          retVal.push(text);
        }
        return retVal;
      }
      var flickrLayer = new ol.layer.Vector({
        source: wifiSource,
        style: wifiStyle
      });

      var tileLayer = new ol.layer.Tile({
        source: new ol.source.OSM()
      });

      var follow_on_map = true;
      var geolocation_on = false;
      var geolocation = null;

      var map = new ol.Map({
        controls: ol.control.defaults().extend([
          new ol.control.FullScreen(),
          new ol.control.OverviewMap({
            collapsed:false,
            layers:[tileLayer]
          }),
          new ol.control.Rotate(),
          new ol.control.Control({
            element: $("<div/>")
            .addClass('ol-unselectable ol-control status-green')
            .css({top:65,left:7})
            .append(
                $("<button/>")
                .attr('title','toggle auto positioning of map')
                .click(function(){
                  $p = $(this).parent();
                  if($p.hasClass('status-red')) {
                    $p.removeClass('status-red').addClass('status-green');
                    follow_on_map = true;
                  } else {
                    $p.removeClass('status-green').addClass('status-red');
                    follow_on_map = false;
                  }
                })
                .append($('<i/>')
                .addClass('fa fa-location-arrow'))
            ).get(0)
          }),
          new ol.control.Control({
            element: $("<div/>")
            .addClass('ol-unselectable ol-control status-red')
            .css({top:100,left:7})
            .append(
                $("<button/>")
                .attr('title','show my location')
                .click(function(){
                  $p = $(this).parent();
                  if($p.hasClass('status-red')) {
                    $p.removeClass('status-red').addClass('status-green');
                    if(geolocation==null) {
                      geolocation = new ol.Geolocation({
                        projection: view.getProjection()
                      });
                      geolocation.on('change:position', function() {
                        if(geolocation_on==true) {
                          var coordinates = geolocation.getPosition();
                          mobilePoint.setCoordinates(coordinates);
                        }
                      });
                    }
                    geolocation_on = true;
                    geolocation.setTracking(true);
                    setTimeout(function(){
                      view.animate({center: geolocation.getPosition(),zoom:(view.getZoom()>=20)?view.getZoom():20});
                    },500);
                  } else {
                    view.animate({center: geolocation.getPosition(),zoom:(view.getZoom()>=20)?view.getZoom():20});
                  }
                })
                .append($('<i/>')
                .addClass('fa fa-mobile'))
            ).get(0)
          }),
          new ol.control.Control({
            element: $("<div/>")
            .addClass('ol-unselectable ol-control status-green')
            .css({top:135,left:7})
            .append(
                $("<button/>")
                .attr('title','where is my device?')
                .click(function(){
                  view.animate({center: dronePoint.getCoordinates(),zoom:(view.getZoom()>=20)?view.getZoom():20});
                })
                .append($('<i/>')
                .addClass('fa fa-plane'))
            ).get(0)
          })
        ]),
        layers: [
          tileLayer,
          flickrLayer,
          new ol.layer.Vector({
            style: function(feature) {
              return feature.get('style');
            },
            source: new ol.source.Vector({features: [droneIconFeature]})
          }),
          new ol.layer.Vector({
            style: function(feature) {
              return feature.get('style');
            },
            source: new ol.source.Vector({features: [mobileIconFeature]})
          })
        ],
        target: 'map',
        view: view
      });

      function wrapLon(value) {
        var worlds = Math.floor((value + 180) / 360);
        return value - (worlds * 360);
      }

      map.on('moveend', function(evt){
        var map = evt.map;
        var extent = map.getView().calculateExtent(map.getSize());
        var bottomLeft = ol.proj.transform(ol.extent.getBottomLeft(extent),'EPSG:3857', 'EPSG:4326');
        var topRight = ol.proj.transform(ol.extent.getTopRight(extent),'EPSG:3857', 'EPSG:4326');
        var l1=wrapLon(bottomLeft[0]);
        var l2=wrapLon(topRight[0]);
        var l3=bottomLeft[1];
        var l4=topRight[1];
        var params = {lat1:Math.min(l3,l4),lat2:Math.max(l3,l4),lon1:Math.min(l1,l2),lon2:Math.max(l1,l2)};
        $.getJSON("{{url_for('kismet.wlan')}}",params, function(data) {
          wifiSource.clear(true)
          var transform = ol.proj.getTransform('EPSG:4326', 'EPSG:3857');
          data.forEach(function(item) {
            var feature = new ol.Feature();
            feature.setId(item.bssid);
            feature.set('ssid',item.ssid);
            feature.set('bssid',item.bssid);
            feature.set('crypto',item.crypto);
            var coordinate = transform([item.lon, item.lat]);
            var geometry = new ol.geom.Point(coordinate);
            feature.setGeometry(geometry);
            wifiSource.addFeature(feature);
          });
        })
      });

      $(document).on("gps:change",function(event,data){
          if(data.fix) {
            var cur_pos = ol.proj.transform([data.lon, data.lat], 'EPSG:4326', 'EPSG:3857');
            dronePoint.setCoordinates(cur_pos);
            if(follow_on_map==true) {
              view.animate({center: cur_pos});
            }
          }
      });

      $(document).ready(function() {
          $("#map").height($('.side-nav').height());
          setTimeout( function() { map.updateSize();}, 200);
          $(window).resize(function() {
            $("#map").height($('.side-nav').height());
            setTimeout( function() { map.updateSize();}, 200);
          });
      });
    </script>
{% endblock %}
