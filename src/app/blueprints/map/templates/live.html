{% extends "map.html" %}

{% block css %}
  {{ super() }}
  <style>
    .map {
      width: 100%;
      height: 600px;
      min-height: 600px;
    }
  </style>
{% endblock %}

{% block body %}
  <div id="map" class="map"></div>
{% endblock %}

{% block js %}
  {{ super() }}
  <script>
      var start = ol.proj.transform([{{gps.lon}},{{gps.lat}}], 'EPSG:4326', 'EPSG:3857');
      var selfPoint = new ol.geom.Point(start);
      var positionIconFeature = new ol.Feature({
        type: 'geoMarker',
        geometry: selfPoint,
        style: new ol.style.Style({
          image: new ol.style.Circle({
            radius: 9,
            snapToPixel: false,
            fill: new ol.style.Fill({color: 'black'}),
            stroke: new ol.style.Stroke({
              color: 'white', width: 2
            })
          })
        })
      });

      var view = new ol.View({
        center: start,
        zoom: 14
      });

      var map = new ol.Map({
        controls: ol.control.defaults().extend([
          new ol.control.FullScreen()
        ]),
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          }),
          new ol.layer.Vector({
            style: function(feature) {
              return feature.get('style');
            },
            source: new ol.source.Vector({features: [positionIconFeature]})
          })
        ],
        target: 'map',
        view: view
      });

      $(document).on("gps:change",function(event,data){
        if(data.fix) {
          var cur_pos = ol.proj.transform([data.lon, data.lat], 'EPSG:4326', 'EPSG:3857');
          view.animate({center: cur_pos});
          selfPoint.setCoordinates(cur_pos);
        } else {

        }
      });

      $(document).ready(function() {
          $("#map").height($('.side-nav').height());
          $(window).resize(function() {
            $("#map").height($('.side-nav').height());
          });
      });
    </script>
{% endblock %}
