{% extends "map.html" %}

{% block css %}
  {{ super() }}
  <style>
    .map {
      width: 100%;
      height: 600px;
      min-height: 600px;
    }
  </style>
{% endblock %}

{% block body %}
  <div id="map" class="map"></div>
{% endblock %}

{% block js %}
  {{ super() }}
  <script>
      var start = ol.proj.transform([{{gpsd.lon}},{{gpsd.lat}}], 'EPSG:4326', 'EPSG:3857');
      var selfPoint = new ol.geom.Point(start);
      var positionIconFeature = new ol.Feature({
        type: 'geoMarker',
        geometry: selfPoint,
        style: new ol.style.Style({
          image: new ol.style.Circle({
            radius: 14,
            snapToPixel: false,
            fill: new ol.style.Fill({color: 'red'}),
            stroke: new ol.style.Stroke({
              color: 'white', width: 2
            })
          })
        })
      });

      var view = new ol.View({
        center: start,
        zoom: 14
      });

      var flickrSource = new ol.source.Vector();
      function flickrStyle(feature) {
        var style = new ol.style.Style({
            fill: new ol.style.Fill({
            color: 'rgba(255,255,255,0.4)'
          }),
          stroke: new ol.style.Stroke({
            color: '#3399CC',
            width: 1.25
          }),
          text: new ol.style.Text({
            font: '14px bold Calibri,sans-serif',
            fill: new ol.style.Fill({ color: '#000' }),
            stroke: new ol.style.Stroke({
              color: '#fff', width: 2
            }),
            text: feature.get('description')?feature.get('description'):''
          }),
          image: new ol.style.Circle({
            radius: 12,
            stroke: new ol.style.Stroke({
              color: 'white',
              width: 2
            }),
            fill: new ol.style.Fill({
              color: 'green'
            })
          })
        });
        return [style];
      }
      var flickrLayer = new ol.layer.Vector({
        source: flickrSource,
        style: flickrStyle
      });

      var map = new ol.Map({
        controls: ol.control.defaults().extend([
          new ol.control.FullScreen()
        ]),
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          }),
          new ol.layer.Vector({
            style: function(feature) {
              return feature.get('style');
            },
            source: new ol.source.Vector({features: [positionIconFeature]})
          }),
          flickrLayer
        ],
        target: 'map',
        view: view
      });



      function wrapLon(value) {
        var worlds = Math.floor((value + 180) / 360);
        return value - (worlds * 360);
      }

      map.on('moveend', function(evt){
        var map = evt.map;
        var extent = map.getView().calculateExtent(map.getSize());
        var bottomLeft = ol.proj.transform(ol.extent.getBottomLeft(extent),'EPSG:3857', 'EPSG:4326');
        var topRight = ol.proj.transform(ol.extent.getTopRight(extent),'EPSG:3857', 'EPSG:4326');
        var l1=wrapLon(bottomLeft[0]);
        var l2=wrapLon(topRight[0]);
        var l3=bottomLeft[1];
        var l4=topRight[1];
        var params = {
          lat1:Math.min(l3,l4),
          lat2:Math.max(l3,l4),
          lon1:Math.min(l1,l2),
          lon2:Math.max(l1,l2)
        };
        $.getJSON("{{url_for('kismet.wlan')}}",params, function(data) {
          flickrSource.clear(true)
          var transform = ol.proj.getTransform('EPSG:4326', 'EPSG:3857');
          data.forEach(function(item) {
            var feature = new ol.Feature();
            feature.setId(item.bssid);
            feature.set('description', (item.ssid?item.ssid:'<Unknown>')+'\n'+item.bssid+(item.crypto?'\n'+item.crypto.split(',').join('\n'):''));
            var coordinate = transform([item.lon, item.lat]);
            var geometry = new ol.geom.Point(coordinate);
            feature.setGeometry(geometry);
            flickrSource.addFeature(feature);
          });
        })
      });

      $(document).on("gps:change",function(event,data){
        if(data.fix) {
          var cur_pos = ol.proj.transform([data.lon, data.lat], 'EPSG:4326', 'EPSG:3857');
          view.animate({center: cur_pos});
          selfPoint.setCoordinates(cur_pos);
        } else {

        }
      });

      $(document).ready(function() {
          $("#map").height($('.side-nav').height());
          setTimeout( function() { map.updateSize();}, 200);
          $(window).resize(function() {
            $("#map").height($('.side-nav').height());
            setTimeout( function() { map.updateSize();}, 200);
          });
      });
    </script>
{% endblock %}
