$(function(){
    var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port,{rememberTransport: false});
    socket.on('gpsd', function(msg) {
      // console.log(msg);
      if(msg.fix) {
        $("#gpsstatus").removeClass('text-red').removeClass('text-orange').addClass('text-green').attr('title','@'+msg.lat+','+msg.lon);
        $("#gpsstatus span.status").text('fix')
        $(document).trigger("gps:change",[msg]);
      } else if(msg.disabled) {
        $("#gpsstatus").removeClass('text-green').removeClass('text-orange').addClass('text-red').attr('title','@'+msg.lat+','+msg.lon);
        $("#gpsstatus span.status").text('off')
        $(document).trigger("gps:change",[msg]);
      } else {
        $("#gpsstatus").removeClass('text-red').removeClass('text-green').addClass('text-orange').attr('title','@'+msg.lat+','+msg.lon);
        $("#gpsstatus span.status").text('on')
        $(document).trigger("gps:change",[msg]);
      }
    });
    socket.on('kismet', function(msg) {
      if(msg) {
        $("#gpsstatus").removeClass('text-red').addClass('text-green');
        $("#gpsstatus span.status").text('on')
      } else {
        $("#gpsstatus").removeClass('text-green').addClass('text-red');
        $("#gpsstatus span.status").text('off')
      }
    });
    $("#system_restart").click(function(event){
      event.preventDefault();
      var $href = $(this);
      BootstrapDialog.show({
          type: BootstrapDialog.TYPE_DANGER,
          title: 'System Reboot',
          message: 'Do you want to reboot the System?',
          buttons: [{
              icon: 'fa fa-fw fa-refresh',
              label: 'Reboot',
              cssClass: 'btn-danger',
              autospin: true,
              action: function(dialogRef){
                  dialogRef.enableButtons(false);
                  dialogRef.setClosable(false);
                  dialogRef.getModalBody().html('Reboot finished in 60 seconds.');
                  $.post($href.attr('href'),function(data){});
                  setTimeout(function(){
                      dialogRef.close();
                      window.location.reload();
                  }, 60000);
              }
          }, {
              label: 'Close',
              action: function(dialogRef){
                  dialogRef.close();
              }
          }]
      });
    });
    $("#system_shutdown").click(function(event){
      event.preventDefault();
      var $href = $(this);
      BootstrapDialog.show({
          type: BootstrapDialog.TYPE_DANGER,
          title: 'System Shutdown',
          message: 'Do you want to shutdown the System?',
          buttons: [{
              icon: 'fa fa-fw fa-refresh',
              label: 'Shutdown',
              cssClass: 'btn-danger',
              autospin: true,
              action: function(dialogRef){
                  $.post($href.attr('href'),function(data){});
                  dialogRef.close();
              }
          }, {
              label: 'Close',
              action: function(dialogRef){
                  dialogRef.close();
              }
          }]
      });
    });

    $("#system_nuke").click(function(event){
      event.preventDefault();
      var $href = $(this);
      BootstrapDialog.show({
          type: BootstrapDialog.TYPE_DANGER,
          title: 'System Reset',
          message: 'Do you want to delete all collected data on the System?',
          buttons: [{
              icon: 'fa fa-fw fa-fire',
              label: 'Set it on fire!',
              cssClass: 'fa-fire',
              autospin: true,
              action: function(dialogRef){
                  $.post($href.attr('href'),function(data){
                    dialogRef.close();
                    if(data && data.status) {
                      BootstrapDialog.show({
                          type: BootstrapDialog.TYPE_INFO,
                          message: 'System successfully nuked' ,
                          buttons: [{
                              label: 'ok',
                              action: function(dialogRef){
                                  window.location.reload();
                                  dialogRef.close();
                              }
                          }]
                      });
                    } else {
                      BootstrapDialog.show({
                          type: BootstrapDialog.TYPE_WARNING,
                          message: 'Error nuking the System, check logs.' ,
                          buttons: [{
                              label: 'ok'
                          }]
                      });
                    }
                  });
              }
          }, {
              label: 'No god, please no!',
              action: function(dialogRef){
                  dialogRef.close();
              }
          }]
      });
  });
});
