from subprocess import Popen, PIPE
from flask_login import current_user
from .. import app
import time

class SystemPasswords:
    def __init__(self,db,user):
        self.db = db
        self.user = user

    def app(self,password):
        self.user.set_password(password)
        self.db.session.commit()
        return True

    @staticmethod
    def ssh(password):
        proc=Popen(['passwd', 'root'],stdin=PIPE,stdout=PIPE,stderr=PIPE)
        proc.stdin.write(password + '\n')
        proc.stdin.write(password)
        proc.stdin.flush()
        stdout,stderr = proc.communicate()
        if len(stdout) > 0: app.logger.info(stdout)
        if len(stderr) > 0: app.logger.error(stderr)
        return proc.returncode == 0

    @staticmethod
    def wlan(password):
        password = password.replace(' ','\\ ')
        proc=Popen(['sed', '-i', 's/^\(wpa_passphrase=\).*/\\1%s/'%password,'/etc/hostapd.conf'],stdin=PIPE,stdout=PIPE,stderr=PIPE)
        stdout,stderr = proc.communicate()
        if len(stdout) > 0: app.logger.info(stdout)
        if len(stderr) > 0: app.logger.error(stderr)
        if proc.returncode == 0:
            proc=Popen(['systemctl', 'stop', 'hostapd.service'],stdin=PIPE,stdout=PIPE,stderr=PIPE)
            stdout,stderr = proc.communicate()
            if len(stdout) > 0: app.logger.info(stdout)
            if len(stderr) > 0: app.logger.error(stderr)
            if proc.returncode == 0:
                time.sleep(5)
                proc=Popen(['systemctl', 'start', 'hostapd.service'],stdin=PIPE,stdout=PIPE,stderr=PIPE)
                stdout,stderr = proc.communicate()
                if len(stdout) > 0: app.logger.info(stdout)
                if len(stderr) > 0: app.logger.error(stderr)
                return proc.returncode == 0
        else:
            return False
